<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Camera Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .video-container {
            position: relative;
            width: 100%;
            max-width: 640px;
            border: 2px solid #ccc;
            margin: 20px auto;
            background: #000;
        }
        video {
            width: 100%;
            display: block;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
        }
        .button-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            margin: 20px 0;
        }
        select {
            padding: 10px;
            margin: 10px;
            width: 100%;
            max-width: 300px;
        }
        #log {
            background: #f0f0f0;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            height: 200px;
            overflow-y: auto;
            margin-top: 20px;
            font-family: monospace;
        }
        .error {
            color: red;
        }
        .success {
            color: green;
        }
    </style>
</head>
<body>
    <h1>Camera Test Tool</h1>
    <p>Dùng trang này để kiểm tra khả năng truy cập camera của bạn.</p>
    
    <div class="video-container">
        <video id="video" playsinline autoplay muted></video>
    </div>
    
    <div class="button-container">
        <button id="startBtn">Bắt đầu Camera</button>
        <button id="stopBtn">Dừng Camera</button>
        <button id="permissionBtn">Kiểm tra Quyền truy cập</button>
    </div>
    
    <div>
        <label for="cameraSelect">Chọn Camera:</label>
        <select id="cameraSelect"></select>
    </div>
    
    <div>
        <h3>Log:</h3>
        <div id="log"></div>
    </div>
    
    <script>
        const video = document.getElementById('video');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const permissionBtn = document.getElementById('permissionBtn');
        const cameraSelect = document.getElementById('cameraSelect');
        const logElement = document.getElementById('log');
        
        let stream = null;
        
        function log(message, type = 'info') {
            const logLine = document.createElement('div');
            logLine.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            if (type === 'error') logLine.className = 'error';
            if (type === 'success') logLine.className = 'success';
            logElement.appendChild(logLine);
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }
        
        async function listCameras() {
            try {
                log('Đang liệt kê camera...');
                const devices = await navigator.mediaDevices.enumerateDevices();
                const cameras = devices.filter(device => device.kind === 'videoinput');
                
                // Xóa các tùy chọn cũ
                cameraSelect.innerHTML = '';
                
                if (cameras.length === 0) {
                    log('Không tìm thấy camera nào!', 'error');
                    return;
                }
                
                // Thêm các camera vào dropdown
                cameras.forEach(camera => {
                    const option = document.createElement('option');
                    option.value = camera.deviceId;
                    option.textContent = camera.label || `Camera ${cameraSelect.options.length + 1}`;
                    cameraSelect.appendChild(option);
                });
                
                log(`Tìm thấy ${cameras.length} camera`, 'success');
            } catch (error) {
                log(`Lỗi liệt kê camera: ${error.message}`, 'error');
            }
        }
        
        async function startCamera() {
            try {
                // Dừng stream hiện tại nếu có
                stopCamera();
                
                log('Đang bắt đầu camera...');
                const constraints = {
                    video: {
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    }
                };
                
                // Sử dụng camera đã chọn nếu có
                if (cameraSelect.value) {
                    constraints.video.deviceId = { exact: cameraSelect.value };
                }
                
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                
                // Đăng ký hàm xử lý sự kiện cho video
                video.onloadedmetadata = () => log('Video metadata loaded', 'success');
                video.onplaying = () => log('Video đang phát', 'success');
                video.onpause = () => log('Video tạm dừng');
                video.onerror = (e) => log(`Lỗi video: ${e}`, 'error');
                
                // Thử phát video
                try {
                    await video.play();
                    log('Camera đã bắt đầu thành công', 'success');
                } catch (e) {
                    log(`Lỗi khi phát video: ${e}`, 'error');
                }
                
                // Cập nhật danh sách camera để có nhãn đầy đủ
                listCameras();
                
            } catch (error) {
                log(`Lỗi truy cập camera: ${error.name} - ${error.message}`, 'error');
            }
        }
        
        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => {
                    track.stop();
                    log(`Đã dừng track: ${track.kind}`);
                });
                video.srcObject = null;
                stream = null;
                log('Đã dừng camera');
            }
        }
        
        async function checkPermission() {
            try {
                log('Kiểm tra quyền truy cập camera...');
                const permissions = await navigator.permissions.query({ name: 'camera' });
                log(`Trạng thái quyền: ${permissions.state}`, permissions.state === 'granted' ? 'success' : 'error');
                
                permissions.onchange = function() {
                    log(`Quyền truy cập đã thay đổi thành: ${this.state}`);
                };
            } catch (error) {
                log(`Không thể kiểm tra quyền: ${error.message}`, 'error');
                log('Thử truy cập camera để kiểm tra quyền...');
                try {
                    const tempStream = await navigator.mediaDevices.getUserMedia({ video: true });
                    tempStream.getTracks().forEach(track => track.stop());
                    log('Có quyền truy cập camera', 'success');
                } catch (e) {
                    log(`Không có quyền truy cập camera: ${e.message}`, 'error');
                }
            }
        }
        
        // Đăng ký các sự kiện
        startBtn.addEventListener('click', startCamera);
        stopBtn.addEventListener('click', stopCamera);
        permissionBtn.addEventListener('click', checkPermission);
        cameraSelect.addEventListener('change', () => {
            log(`Đã chọn camera: ${cameraSelect.options[cameraSelect.selectedIndex].text}`);
            if (stream) {
                startCamera(); // Khởi động lại camera với thiết bị mới
            }
        });
        
        // Khởi tạo
        log('Trang kiểm tra camera đã sẵn sàng');
        listCameras();
        
        // Kiểm tra hỗ trợ camera cơ bản
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            log('Trình duyệt này không hỗ trợ getUserMedia API!', 'error');
        } else {
            log('Trình duyệt hỗ trợ getUserMedia API', 'success');
        }
    </script>
</body>
</html> 